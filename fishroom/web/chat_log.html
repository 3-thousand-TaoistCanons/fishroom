{% extends "base.html" %}

{% block content %}

<div class="row">
	<div class="col-md-12">
		{% if not embedded %} <h3>{{title}}</h3> {% end %}
		<ul id="logs">
			{% for id, msg in enumerate(msgs, next_id-limit) %}
			{% if msg %}
			<li class="row" data-id="{{id}}">
				<span class="nickname col-xs-6 nick-color-{{msg.name_style_num}}">{{msg.sender}}</span>
				<span class="time col-xs-6 text-right">{{msg.time}}</span>
				<span class="col-xs-12">
					<span class="content">
					{% if msg.mtype not in ("photo", "sticker", "audio") %}{% raw escape(msg.content).replace('\n', '<br />') %}{% end%}
					</span>
					{% if msg.mtype in ("photo", "sticker") %}
						<img class="thumbnail fishroom-{{msg.mtype}}" src="{% if msg.media_url %}{{ msg.media_url }}{% else %}{{msg.content.split()[0]}}{% end %}" />
					{% elif msg.mtype == "audio" %}
						<audio class="fishroom-audio" controls><source src="{{msg.media_url}}" /></audio>
					{% end %}
				</span>
			</li>
			{% end %}
			{% end %}
		</ul>
	</div>
</div>

{% if not embedded %}
<div class="row" id="footer">
	<div class="col-md-12">
		<div class="text-center">
			<span>Powered by <a href="https://github.com/tuna/fishroom">Fishroom</a> </span>| <span>Licensed under AGPLv3</span>
			{% if 'sponsor' in fishroom.config.config %} | <span>{% raw fishroom.config.config['sponsor']['footer'] %}</span>{% end %}
		</div>
	</div>
</div>
{% end %}

<div id="chatbar" class="row">
	<div class="join-chat hidden">
		<form class="form-inline">
			<div class="form-group">
				<label for="my-nickname">Nickname</label>
				<input type="text" class="form-control" id="my-nickname" />
			</div>
			<span class="btn btn-primary" id="btn-set-nickname"> Join Chat </span>
		</form>
	</div>
	<div class="send-text hidden">
		<form>
			<div class="form-group">
				<label class="sr-only" for="my-msg-text"></label>
				<div class="input-group">
					<span class="input-group-addon"></span>
					<input type="text" class="form-control" id="my-msg-text" />
				</div>
			</div>
			<span class="btn btn-primary" id="btn-send-msg"> Send </span>
		</form>
	</div>
</div>

{% end %}

{% block js %}
<script src="//cdn.bootcss.com/blueimp-md5/1.1.1/js/md5.min.js"></script>

<script>
$(document).ready(function() {
	var getColorNum = function() {
		var cache = {};
		function getColorNum_(str) {
			if (cache[str]) {
				return cache[str];
			}
			var frag = parseInt(md5(str).substr(0, 8), 16);
			return frag & 0x07;
		}
		return getColorNum_;
	}();

	var esc = function(content) {
		return 	content
						.replace(/</g, '&lt')
						.replace(/>/g, '&gt')
						.replace(/(?:\r\n|\r|\n)/g, '<br/>')
	};

	var convert = function(content){
		var urlify = function(text) {
			var urlRegex = /(https?:\/\/[^\s]+)/g;
			return text.replace(urlRegex, '<a href="$1">$1</a>')
		}
		return emojione.toImage(urlify(content));
	};

	var new_message = function() {
		var next_id = {{next_id}};
		var _thumb = function(msg) {
			if (msg.mtype == "photo" || msg.mtype == "sticker") {
				return '<img class="thumbnail fishroom-' + msg.mtype + '" src="' + msg.media_url + '" />';
			}
			else if (msg.mtype == "audio") {
				return '<audio class="fishroom-audio" controls><source src="' + msg.media_url + '" /></audio>';
			}
			return "";
		};
		var _content = function(msg) {
			if (msg.mtype == "photo" || msg.mtype == "sticker") {
				return "";
			}
			return convert(esc(msg.content));
		};
		function _new_message(msg) {
			$("ul#logs").append(
					'<li class="row" data-id="' + next_id + '">' + 
					'<span class="nickname col-xs-6 nick-color-' + getColorNum(msg.sender) + '">' + msg.sender + '</span>' +
					'<span class="time col-xs-6 text-right">' + msg.time + '</span>'	+
					'<span class="col-xs-12">' + 
						'<span class="content ">' + _content(msg) + '</span>' + _thumb(msg) +
					'</span>' +
					'</li>'
					);
			next_id++;
		}
		return _new_message;
	}();

	$("#logs > li").each(function(i, e){
		var content = $(e).find(".content");
		content.html(convert(content.html()));
	});

	{% if enable_ws %}
	window.CreateWebSocket = function() {
		var scheme=document.location.protocol.replace(/^http/g, 'ws'), 
				host=document.location.host,
				wsurl = scheme + '//' + host + '{{basepath}}/msg_stream';
				ws = new WebSocket(wsurl);

		ws.onopen = function() {
			ws.send('{"room": "{{room}}"}');
		};

		ws.onmessage = function(ev) {
			if (ev.data == "OK") {
				console.log("OK");
			} else {
				var msg = JSON.parse(ev.data);
				// console.log(msg);
				new_message(msg);
				window.scrollTo(0,document.body.scrollHeight);
			}
		};
		ws.onclose = function(ev) {
			console.log("socket closed, try reconnecting");
			setTimeout(function(){
				CreateWebSocket();
			}, 5*1000);
		};
	};
	
	CreateWebSocket();
	{% end %}
	
	$("#chatbar").css("width", $(".container>.row").width()+"px");
	
	var nickname = localStorage.getItem("nickname");
	window.sendCoolDown = false;
	

	if (!nickname) {
		$(".join-chat").removeClass("hidden");
	} else {
		$(".send-text").removeClass("hidden").find(".input-group-addon").text(nickname);
	}
	
	var set_nickname = function(){
		nickname = $("input#my-nickname").val();
		// console.log(nickname)
		localStorage.setItem("nickname", nickname);
		$(".join-chat").addClass("hidden");
		$(".send-text").removeClass("hidden").find(".input-group-addon").text(nickname);
	};
	$("input#my-nickname").keypress(function(e){
		if ((e.keyCode || e.which) == 13) {
			set_nickname();
			return false;
		}
	});
	$('#btn-set-nickname').click(set_nickname);
	
	var send_fishmsg = function(){
		if(window.sendCoolDown) {
			return;
		}

		var msg = $("#my-msg-text").val(),
				data = {nickname: nickname, content: msg};

		$.ajax({
			type: "POST",
			url: "/messages/{{room}}/",
			data: JSON.stringify(data),
		}).done(function(msg){
			$('#my-msg-text').val('');
			$("#btn-send-msg").attr("disabled", "disabled");
			window.sendCoolDown = true;
			setTimeout(function(){
				window.sendCoolDown = false;
				$("#btn-send-msg").removeAttr("disabled");
			}, 500);
		});
	};

	$("input#my-msg-text").keypress(function(e){
		if ((e.keyCode || e.which) == 13) {
			send_fishmsg();
			return false;
		}
	});
	$('#btn-send-msg').click(send_fishmsg);

});
</script>
{% end %}

{% block css %}
<style>
body>div.container {
	max-width: 800px;
	padding-bottom: 100px;
}
ul#logs {
	font-size: 14px;
	list-style-type: none;
	font-family: monospace;
	padding-left: 0;
	padding-top: 10px;
}
ul#logs > li {
	padding-top: 7px;
	padding-bottom: 7px;
	line-height: 1.33;
	border-top: 1px solid #EEE;
}
ul#logs > li:hover {
	background-color: #fafafa;
}
ul#logs > li:first-child {
	border-top: none;
}
ul#logs > li > span.time {
	color: #888;
}
ul#logs > li span.content {
	font-family: 'Source Han Sans CN', 'WenQuanYi Zen Hei', 'WenQuanYi Micro Hei', 'Heiti SC', 'Hiragino Sans GB', 'STHeiti', '微软雅黑', sans-serif;
	min-height: 20px;
}
ul#logs > li img.thumbnail {
	margin-top: 5px;
	max-height: 300px;
	max-width: 100%;
}
ul#logs > li audio.fishroom-audio {
	margin-top: 5px;
}
ul#logs > li img.thumbnail.fishroom-sticker {
	max-width: 200px;
	border: none;
}
ul#logs .nick-color-0 {
	color: #F89406;
}
ul#logs .nick-color-1 {
	color: #9A12B3;
}
ul#logs .nick-color-2 {
	color: #4183D7;
}
ul#logs .nick-color-3 {
	color: #00B16A;
}
ul#logs .nick-color-4 {
	color: #F9690E;
}
ul#logs .nick-color-5 {
	color: #D2527F;
}
ul#logs .nick-color-6 {
	color: #1BA39C;
}
ul#logs .nick-color-7 {
	color: #1F3A93;
}

#footer {
	padding: 40px 0;
}
#footer img {
	max-height: 30px;
}

#chatbar {
	position: fixed;
	bottom: 0;
	height: 100px;
	background: white;
}
</style>

{% end %}
{#
vim: ts=2 sts=2 sw=2 noexpandtab
#}
