{% extends "base.html" %}

{% block content %}

<div class="row">
	<div class="col-md-12">
		{% if not embedded %} <h3>{{title}}</h3> {% end %}
		<ul id="logs">
			{% for id, msg in enumerate(msgs) %}
			{% if not embedded or id > next_id-limit-1 %}	
			<li class="row" data-id="{{id}}">
				<span class="nickname col-xs-6 nick-color-{{msg.name_style_num}}">{{msg.sender}}</span>
				<span class="time col-xs-6 text-right">{{msg.time}}</span>
				<span class="col-xs-12">
					<span class="content">{% raw escape(msg.content).replace('\n', '<br />') %}</span>
					{% if msg.mtype in ("photo", "sticker") %}
					<img class="thumbnail" src="{% if msg.media_url %}{{ msg.media_url }}{% else %}{{msg.content.split()[0]}}{% end %}" />
					{% end %}
				</span>
			</li>
			{% end %}
			{% end %}
		</ul>
	</div>
</div>

{% if not embedded %}
<div class="row" id="footer">
	<div class="col-md-12">
		<div class="text-center">Powered by <a href="https://github.com/tuna/fishroom">Fishroom</a> | Licensed under AGPLv3</div>
	</div>
</div>

{% end %}

{% end %}

{% block js %}
<script src="//cdn.bootcss.com/blueimp-md5/1.1.1/js/md5.min.js"></script>

<script>
$(document).ready(function() {
	var getColorNum = function() {
		var cache = {};
		function getColorNum_(str) {
			if (cache[str]) {
				return cache[str];
			}
			var frag = parseInt(md5(str).substr(0, 8), 16);
			return frag & 0x07;
		}
		return getColorNum_;
	}();

	var convert = function(content){
		var urlify = function(text) {
			var urlRegex = /(https?:\/\/[^\s]+)/g;
			return text.replace(urlRegex, '<a href="$1">$1</a>')
		}
		return emojione.toImage(
				urlify(
					content
					.replace(/</g, '&lt')
					.replace(/>/g, '&gt')
					.replace(/(?:\r\n|\r|\n)/g, '<br/>')
				)
			);
	};

	var new_message = function() {
		var next_id = {{next_id}};
		var _thumb = function(msg) {
			if (msg.mtype == "photo" || msg.mtype == "sticker") {
				return '<img class="thumbnail" src="' + msg.media_url + '">'
			}
			return "";
		};
		function _new_message(msg) {
			$("ul#logs").append(
					'<li class="row" data-id="' + next_id + '">' + 
					'<span class="nickname col-xs-6 nick-color-' + getColorNum(msg.sender) + '">' + msg.sender + '</span>' +
					'<span class="time col-xs-6 text-right">' + msg.time + '</span>'	+
					'<span class="col-xs-12">' + 
						'<span class="content ">' + convert(msg.content) + '</span>' + _thumb(msg) +
					'</span>' +
					'</li>'
					);
			next_id++;
		}
		return _new_message;
	}();

	window.CreateWebSocket = function() {
		var ws = new WebSocket("{{wsbaseurl}}/msg_stream");
		ws.onopen = function() {
			ws.send('{"channel": "{{channel}}"}');
		};
		ws.onmessage = function(ev) {
			if (ev.data == "OK") {
				console.log("OK");
			} else {
				var msg = JSON.parse(ev.data);
				// console.log(msg);
				new_message(msg);
				window.scrollTo(0,document.body.scrollHeight);
			}
		};
		ws.onclose = function(ev) {
			console.log("socket closed, try reconnecting");
			setTimeout(function(){
				CreateWebSocket();
			}, 5*1000);
		};
	};

	CreateWebSocket();

});
</script>
{% end %}

{% block css %}
<style>
body>div.container {
	max-width: 800px;
}
ul#logs {
	font-size: 14px;
	list-style-type: none;
	font-family: monospace;
	padding-left: 0;
	padding-top: 10px;
}
ul#logs > li {
	padding-top: 7px;
	padding-bottom: 7px;
	line-height: 1.33;
	border-top: 1px solid #EEE;
}
ul#logs > li:hover {
	background-color: #fafafa;
}
ul#logs > li:first-child {
	border-top: none;
}
ul#logs > li > span.time {
	color: #888;
}
ul#logs > li span.content {
	font-family: 'Source Han Sans CN', 'WenQuanYi Zen Hei', 'WenQuanYi Micro Hei', 'Heiti SC', 'Hiragino Sans GB', 'STHeiti', '微软雅黑', sans-serif;
	min-height: 20px;
}
ul#logs > li img.thumbnail {
	max-height: 300px;
	max-width: 100%;
}
ul#logs .nick-color-0 {
	color: #F89406;
}
ul#logs .nick-color-1 {
	color: #9A12B3;
}
ul#logs .nick-color-2 {
	color: #4183D7;
}
ul#logs .nick-color-3 {
	color: #00B16A;
}
ul#logs .nick-color-4 {
	color: #F9690E;
}
ul#logs .nick-color-5 {
	color: #D2527F;
}
ul#logs .nick-color-6 {
	color: #1BA39C;
}
ul#logs .nick-color-7 {
	color: #1F3A93;
}

#footer {
	padding: 40px 0;
}
</style>

{% end %}
{#
vim: ts=2 sts=2 sw=2 noexpandtab
#}
